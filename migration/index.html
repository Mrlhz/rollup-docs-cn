<!DOCTYPE html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>迁移到 Rollup 4 | Rollup 中文文档</title>
    <meta name="description" content="编译 JS 代码">
    <meta name="generator" content="VitePress v1.6.3">
    <link rel="preload stylesheet" href="/rollup-docs-cn/assets/style.CZJ5yQce.css" as="style">
    <link rel="preload stylesheet" href="/rollup-docs-cn/vp-icons.css" as="style">
    
    <script type="module" src="/rollup-docs-cn/assets/app.BPO_b_ck.js"></script>
    <link rel="preload" href="/rollup-docs-cn/assets/inter-roman-latin.Di8DUHzh.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/rollup-docs-cn/assets/chunks/theme.CeqEnVUd.js">
    <link rel="modulepreload" href="/rollup-docs-cn/assets/chunks/framework.nT7dnMoH.js">
    <link rel="modulepreload" href="/rollup-docs-cn/assets/migration_index.md.DMCeHX2-.lean.js">
    <link href="/favicon.png" rel="icon" type="image/png">
    <link href="/favicon.png" rel="apple-touch-icon" sizes="128x128">
    <link href="/manifest.json" rel="manifest">
    <meta content="#333333" name="theme-color">
    <meta content="yes" name="mobile-web-app-capable">
    <meta content="default" name="apple-mobile-web-app-status-bar-style">
    <meta content="summary_large_image" name="twitter:card">
    <meta content="@rollupjs" name="twitter:site">
    <meta content="@rollupjs" name="twitter:creator">
    <meta content="Rollup" name="twitter:title">
    <meta content="The JavaScript module bundler" name="twitter:description">
    <meta content="https://rollupjs.org/twitter-card.jpg" name="twitter:image">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-5d98c3a5><!--[--><!--]--><!--[--><span tabindex="-1" data-v-0b0ada53></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-0b0ada53>Skip to content</a><!--]--><!----><header class="VPNav" data-v-5d98c3a5 data-v-ae24b3ad><div class="VPNavBar" data-v-ae24b3ad data-v-6aa21345><div class="wrapper" data-v-6aa21345><div class="container" data-v-6aa21345><div class="title" data-v-6aa21345><div class="VPNavBarTitle has-sidebar" data-v-6aa21345 data-v-1168a8e4><a class="title" href="/rollup-docs-cn/" data-v-1168a8e4><!--[--><!--]--><!--[--><img class="VPImage logo" src="/rollup-docs-cn/rollup-logo.svg" alt data-v-8426fc1a><!--]--><span data-v-1168a8e4>Rollup 中文文档</span><!--[--><!--]--></a></div></div><div class="content" data-v-6aa21345><div class="content-body" data-v-6aa21345><!--[--><!--]--><div class="VPNavBarSearch search" data-v-6aa21345><!--[--><!----><div id="docsearch"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><span class="vp-icon DocSearch-Search-Icon"></span><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div><!--]--></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-6aa21345 data-v-dc692963><span id="main-nav-aria-label" class="visually-hidden" data-v-dc692963> Main Navigation </span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/rollup-docs-cn/introduction/" tabindex="0" data-v-dc692963 data-v-e56f3d57><!--[--><span data-v-e56f3d57>指南</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/rollup-docs-cn/repl/" tabindex="0" data-v-dc692963 data-v-e56f3d57><!--[--><span data-v-e56f3d57>repl</span><!--]--></a><!--]--><!--[--><a class="VPLink link vp-external-link-icon VPNavBarMenuLink" href="https://is.gd/rollup_chat" target="_blank" rel="noreferrer" tabindex="0" data-v-dc692963 data-v-e56f3d57><!--[--><span data-v-e56f3d57>聊天</span><!--]--></a><!--]--><!--[--><a class="VPLink link vp-external-link-icon VPNavBarMenuLink" href="https://opencollective.com/rollup" target="_blank" rel="noreferrer" tabindex="0" data-v-dc692963 data-v-e56f3d57><!--[--><span data-v-e56f3d57>opencollective</span><!--]--></a><!--]--><!--]--></nav><div class="VPFlyout VPNavBarTranslations translations" data-v-6aa21345 data-v-88af2de4 data-v-cf11d7a2><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="Change language" data-v-cf11d7a2><span class="text" data-v-cf11d7a2><span class="vpi-languages option-icon" data-v-cf11d7a2></span><!----><span class="vpi-chevron-down text-icon" data-v-cf11d7a2></span></span></button><div class="menu" data-v-cf11d7a2><div class="VPMenu" data-v-cf11d7a2 data-v-b98bc113><!----><!--[--><!--[--><div class="items" data-v-88af2de4><p class="title" data-v-88af2de4>简体中文</p><!--[--><div class="VPMenuLink" data-v-88af2de4 data-v-35975db6><a class="VPLink link vp-external-link-icon" href="https://rollupjs.org/migration/" target="_blank" rel="noreferrer" data-v-35975db6><!--[--><span data-v-35975db6>English</span><!--]--></a></div><!--]--></div><!--]--><!--]--></div></div></div><div class="VPNavBarAppearance appearance" data-v-6aa21345 data-v-6c893767><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-6c893767 data-v-5337faa4 data-v-1d5665e3><span class="check" data-v-1d5665e3><span class="icon" data-v-1d5665e3><!--[--><span class="vpi-sun sun" data-v-5337faa4></span><span class="vpi-moon moon" data-v-5337faa4></span><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-6aa21345 data-v-0394ad82 data-v-7bc22406><!--[--><a class="VPSocialLink no-icon" href="https://github.com/rollup/rollup" aria-label="github" target="_blank" rel="noopener" data-v-7bc22406 data-v-bd121fe5><span class="vpi-social-github"></span></a><a class="VPSocialLink no-icon" href="https://m.webtoo.ls/@rollupjs" aria-label="mastodon" target="_blank" rel="noopener" data-v-7bc22406 data-v-bd121fe5><span class="vpi-social-mastodon"></span></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-6aa21345 data-v-bb2aa2f0 data-v-cf11d7a2><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-cf11d7a2><span class="vpi-more-horizontal icon" data-v-cf11d7a2></span></button><div class="menu" data-v-cf11d7a2><div class="VPMenu" data-v-cf11d7a2 data-v-b98bc113><!----><!--[--><!--[--><div class="group translations" data-v-bb2aa2f0><p class="trans-title" data-v-bb2aa2f0>简体中文</p><!--[--><div class="VPMenuLink" data-v-bb2aa2f0 data-v-35975db6><a class="VPLink link vp-external-link-icon" href="https://rollupjs.org/migration/" target="_blank" rel="noreferrer" data-v-35975db6><!--[--><span data-v-35975db6>English</span><!--]--></a></div><!--]--></div><div class="group" data-v-bb2aa2f0><div class="item appearance" data-v-bb2aa2f0><p class="label" data-v-bb2aa2f0>Appearance</p><div class="appearance-action" data-v-bb2aa2f0><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-bb2aa2f0 data-v-5337faa4 data-v-1d5665e3><span class="check" data-v-1d5665e3><span class="icon" data-v-1d5665e3><!--[--><span class="vpi-sun sun" data-v-5337faa4></span><span class="vpi-moon moon" data-v-5337faa4></span><!--]--></span></span></button></div></div></div><div class="group" data-v-bb2aa2f0><div class="item social-links" data-v-bb2aa2f0><div class="VPSocialLinks social-links-list" data-v-bb2aa2f0 data-v-7bc22406><!--[--><a class="VPSocialLink no-icon" href="https://github.com/rollup/rollup" aria-label="github" target="_blank" rel="noopener" data-v-7bc22406 data-v-bd121fe5><span class="vpi-social-github"></span></a><a class="VPSocialLink no-icon" href="https://m.webtoo.ls/@rollupjs" aria-label="mastodon" target="_blank" rel="noopener" data-v-7bc22406 data-v-bd121fe5><span class="vpi-social-mastodon"></span></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-6aa21345 data-v-e5dd9c1c><span class="container" data-v-e5dd9c1c><span class="top" data-v-e5dd9c1c></span><span class="middle" data-v-e5dd9c1c></span><span class="bottom" data-v-e5dd9c1c></span></span></button></div></div></div></div><div class="divider" data-v-6aa21345><div class="divider-line" data-v-6aa21345></div></div></div><!----></header><div class="VPLocalNav has-sidebar empty" data-v-5d98c3a5 data-v-a6f0e41e><div class="container" data-v-a6f0e41e><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-a6f0e41e><span class="vpi-align-left menu-icon" data-v-a6f0e41e></span><span class="menu-text" data-v-a6f0e41e>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-a6f0e41e data-v-8a42e2b4><button data-v-8a42e2b4>Return to top</button><!----></div></div></div><aside class="VPSidebar" data-v-5d98c3a5 data-v-319d5ca6><div class="curtain" data-v-319d5ca6></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-319d5ca6><span class="visually-hidden" id="sidebar-aria-label" data-v-319d5ca6> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="no-transition group" data-v-c40bc020><section class="VPSidebarItem level-0" data-v-c40bc020 data-v-b3fd67f8><div class="item" role="button" tabindex="0" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><h2 class="text" data-v-b3fd67f8>起步</h2><!----></div><div class="items" data-v-b3fd67f8><!--[--><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/rollup-docs-cn/introduction/" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>简介</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/rollup-docs-cn/command-line-interface/" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>命令行接口</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/rollup-docs-cn/javascript-api/" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>Javascript API</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-c40bc020><section class="VPSidebarItem level-0 has-active" data-v-c40bc020 data-v-b3fd67f8><div class="item" role="button" tabindex="0" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><h2 class="text" data-v-b3fd67f8>更多信息</h2><!----></div><div class="items" data-v-b3fd67f8><!--[--><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/rollup-docs-cn/tutorial/" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>教程</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/rollup-docs-cn/es-module-syntax/" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>ES 模块语法</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/rollup-docs-cn/faqs/" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>常见问题</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/rollup-docs-cn/troubleshooting/" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>故障排除</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/rollup-docs-cn/migration/" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>迁移到 Rollup 4</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/rollup-docs-cn/tools/" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>其它工具</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-c40bc020><section class="VPSidebarItem level-0" data-v-c40bc020 data-v-b3fd67f8><div class="item" role="button" tabindex="0" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><h2 class="text" data-v-b3fd67f8>API</h2><!----></div><div class="items" data-v-b3fd67f8><!--[--><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/rollup-docs-cn/configuration-options/" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>配置选项</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/rollup-docs-cn/plugin-development/" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>插件开发</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-5d98c3a5 data-v-1428d186><div class="VPDoc has-sidebar has-aside" data-v-1428d186 data-v-39a288b8><!--[--><!--]--><div class="container" data-v-39a288b8><div class="aside" data-v-39a288b8><div class="aside-curtain" data-v-39a288b8></div><div class="aside-container" data-v-39a288b8><div class="aside-content" data-v-39a288b8><div class="VPDocAside" data-v-39a288b8 data-v-3f215769><!--[--><!--]--><!--[--><!--]--><nav aria-labelledby="doc-outline-aria-label" class="VPDocAsideOutline" data-v-3f215769 data-v-a5bbad30><div class="content" data-v-a5bbad30><div class="outline-marker" data-v-a5bbad30></div><div aria-level="2" class="outline-title" id="doc-outline-aria-label" role="heading" data-v-a5bbad30>On this page</div><ul class="VPDocOutlineItem root" data-v-a5bbad30 data-v-b933a997><!--[--><!--]--></ul></div></nav><!--[--><!--]--><div class="spacer" data-v-3f215769></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-39a288b8><div class="content-container" data-v-39a288b8><!--[--><!--]--><main class="main" data-v-39a288b8><div style="position:relative;" class="vp-doc _rollup-docs-cn_migration_" data-v-39a288b8><div><h1>迁移到 Rollup 4</h1><nav class="table-of-contents"><ul><li><a href="#prerequisites">前提条件</a></li><li><a href="#general-changes">总体变更</a></li><li><a href="#configuration-changes">配置变化</a></li><li><a href="#changes-to-the-plugin-api">插件 API 的变更</a></li><li><a href="#migrating-to-rollup-3">迁移到 Rollup 3</a></li><li><a href="#prerequisites-v3">前置要求</a></li><li><a href="#using-configuration-files">配置文件使用</a></li><li><a href="#changed-defaults">默认值更改</a></li><li><a href="#more-changed-options">其他选项更改</a></li><li><a href="#dynamic-import-in-commonjs-output">从 CommonJS 输出中的动态导入</a></li><li><a href="#changes-to-the-plugin-api-v3">插件 API 更改</a></li></ul></nav><p>这里列举了一些在迁移 Rollup 3 时可能遇到的重要问题。有关所有破坏性更新的完整列表，我们建议你查阅：</p><ul><li><a href="https://github.com/rollup/rollup/blob/master/CHANGELOG.md#400" target="_blank" rel="noreferrer">Rollup 4 changelog</a></li></ul><p>从 Rollup 3 或更早版本迁移时，请参阅 <a href="#migrating-to-rollup-3">下面的部分</a>.</p><h2 id="prerequisites" tabindex="-1">前提条件 <a class="header-anchor" href="#prerequisites" aria-label="Permalink to &quot;前提条件 {#prerequisites}&quot;">​</a></h2><p>确保你的 Node 版本至少为 18.0.0，并更新所有 Rollup 插件到最新版本。</p><p>对于更大的配置，首先更新到 <code>rollup@3.29.4</code>，将 <a href="./../configuration-options/#strictdeprecations"><code>strictDeprecations</code></a> 选项添加到你的配置中，并解决弹出的所有错误。这样，你可以确保你不依赖可能在 Rollup 4 中被删除的功能。如果你的插件有错误，请联系插件作者。</p><h2 id="general-changes" tabindex="-1">总体变更 <a class="header-anchor" href="#general-changes" aria-label="Permalink to &quot;总体变更 {#general-changes}&quot;">​</a></h2><p>Rollup 现在包含了自动安装（和删除）的原生代码，如果你的平台和架构受到支持，它将作为 <a href="https://docs.npmjs.com/cli/v10/configuring-npm/package-json#optionaldependencies" target="_blank" rel="noreferrer">可选的 npm 依赖</a> 自动安装。更准确地说，Rollup 有一个 <code>optionalDependencies</code> 列表，每个列表只安装在特定的 <a href="https://docs.npmjs.com/cli/v10/configuring-npm/package-json#os" target="_blank" rel="noreferrer"><code>os</code></a> 和 <a href="https://docs.npmjs.com/cli/v10/configuring-npm/package-json#cpu" target="_blank" rel="noreferrer"><code>cpu</code></a> 上。如果你的系统不受支持，当你启动 Rollup 时，你将收到一个错误消息，该消息将告诉你你的平台和架构，并给出一个支持的列表。在这种情况下，你可以使用 <code>@rollup/wasm-node</code> 作为独立的跨平台替代品。</p><p>面向浏览器的构建（NPM 上的 <code>@rollup/browser</code>）现在依赖于一个需要提供的 WASM 文件。如果你正在使用 Vite 的浏览器构建，你需要将 <code>&quot;@rollup/browser&quot;</code> 添加到 <code>optimizeDeps.exclude</code> 中，否则 <code>npm run dev</code> 将因为 <code>.wasm</code> 文件的无效路径而失败（请参阅 <a href="https://github.com/vitejs/vite/issues/14609" target="_blank" rel="noreferrer">vitejs #14609</a>）。否则，它应该可以正常工作，无需任何特定的干预。</p><p>另外，一个明显的变化是，Rollup 现在在文件名中使用 URL 安全的 base64 哈希值，而不是旧的 base16 哈希值。这种方式提供了更高的哈希安全性，但由于技术原因，哈希长度现在最多限制为 21 个字符。</p><p>当打包 CLI 应用程序时，如果输出 <a href="./../configuration-options/#output-format"><code>format</code></a> 为 <code>es</code> 或 <code>cjs</code>，Rollup 现在将自动保留入口文件中的 shebang 注释。以前，你需要通过插件添加注释。</p><p>最后，你可能会看到一些新的关于无效注释位置的警告。如果 Rollup 发现一个 <a href="./../configuration-options/#pure"><code>@__PURE__</code></a> 或 <a href="./../configuration-options/#no-side-effects"><code>@__NO_SIDE_EFFECTS__</code></a> 注释，它无法解释，因为它位于无效的位置，现在将发出警告。这些警告是为了帮助调试。为了消除它们，<a href="./../command-line-interface/#filterlogs-filter"><code>--filter-logs</code></a> CLI 选项可以帮助你。</p><h2 id="configuration-changes" tabindex="-1">配置变化 <a class="header-anchor" href="#configuration-changes" aria-label="Permalink to &quot;配置变化 {#configuration-changes}&quot;">​</a></h2><p>由于一些选项在 Rollup 3 中已经被弃用，因此这里唯一的主要变化是我们不再有 <code>acorn</code> 和 <code>acornInjectPlugin</code> 选项。这意味着，不幸的是，你不能再为不支持的语法添加插件。根据需求，我们考虑再次支持 JSX 语法，因为 SWC 解析器将支持该语法。</p><h2 id="changes-to-the-plugin-api" tabindex="-1">插件 API 的变更 <a class="header-anchor" href="#changes-to-the-plugin-api" aria-label="Permalink to &quot;插件 API 的变更 {#changes-to-the-plugin-api}&quot;">​</a></h2><p>一个重要变更是，<a href="./../plugin-development/#this-resolve"><code>this.resolve()</code></a> 现在默认会添加 <code>skipSelf: true</code>。这意味着当从 <a href="./../plugin-development/#resolveid"><code>resolveId</code></a> 钩子调用 <code>this.resolve()</code> 时，除非它们使用不同的 <code>source</code> 或 <code>importer</code>，否则此钩子将不会被此或其他插件的进一步嵌套 <code>this.resolve()</code> 调用再次调用。我们发现这对于大多数插件来说是一个合理的默认值，可以防止意外的无限循环。要获得旧的行为，你可以手动添加 <code>skipSelf: false</code>。</p><p>另一个重要变更是，Rollup 的 watch 模式将不再监视通过插件 <a href="./../plugin-development/#load"><code>load</code></a> 钩子加载的文件的 id。因此，这主要影响“虚拟”文件，其中监视硬盘位置的更改确实没有意义。相反，现在由使用 <code>load</code> 钩子的插件手动调用 <a href="./../plugin-development/#this-addwatchfile"><code>this.addWatchFile()</code></a> 来处理 <code>load</code> 钩子所依赖的所有文件。</p><p>如果你的插件会处理导入断言，请注意在 <a href="./../plugin-development/#resolveid"><code>resolveId</code></a> 钩子和其他地方，<code>assertions</code> 已被替换为 <code>attributes</code>，因为 JavaScript 功能也被重命名。此外，导入属性的抽象语法树表示现在再次遵循 <a href="https://github.com/estree/estree/blob/7a0c8fb02a33a69fa16dbe3ca35beeaa8f58f1e3/experimental/import-attributes" target="_blank" rel="noreferrer">ESTree 规范</a>。</p><p>如果你想要从你的插件中发出警告，你不能再在 <a href="./../plugin-development/#buildstart"><code>buildStart</code></a> 钩子中调用 <code>options.onwarn()</code>。相反，使用 <a href="./../plugin-development/#load"><code>this.warn()</code></a> 或 <a href="./../configuration-options/#onlog"><code>options.onLog()</code></a>。</p><h2 id="migrating-to-rollup-3" tabindex="-1">迁移到 Rollup 3 <a class="header-anchor" href="#migrating-to-rollup-3" aria-label="Permalink to &quot;迁移到 Rollup 3 {#migrating-to-rollup-3}&quot;">​</a></h2><p>这里是你在从 Rollup 2 迁移到 Rollup 3 时可能遇到的最重要的主题列表。有关所有破坏性更新的完整列表，我们建议你查阅：</p><ul><li><a href="https://github.com/rollup/rollup/blob/master/CHANGELOG.md#300" target="_blank" rel="noreferrer">Rollup 3 更新日志</a></li></ul><p>从 Rollup 1 或更早版本迁移时，请参阅</p><ul><li><a href="https://github.com/rollup/rollup/blob/master/CHANGELOG.md#200" target="_blank" rel="noreferrer">Rollup 2 更新日志</a></li><li><a href="https://github.com/rollup/rollup/blob/master/CHANGELOG.md#100" target="_blank" rel="noreferrer">Rollup 1 更新日志</a></li></ul><h2 id="prerequisites-v3" tabindex="-1">前置要求 <a class="header-anchor" href="#prerequisites-v3" aria-label="Permalink to &quot;前置要求 {#prerequisites-v3}&quot;">​</a></h2><p>请确保你的 Node 版本至少为 14.18.0，并更新所有 Rollup 插件到最新版本。</p><p>对于较大的配置，请首先更新到 <code>rollup@2.79.1</code> ，将 <a href="./../configuration-options/#strictdeprecations"><code>strictDeprecations</code></a> 选项添加到你的配置中，并解决弹出的所有错误。这样，你可以确保你不依赖可能在 Rollup 3 中被删除的功能。如果你的插件有错误，请联系插件作者。</p><h2 id="using-configuration-files" tabindex="-1">配置文件使用 <a class="header-anchor" href="#using-configuration-files" aria-label="Permalink to &quot;配置文件使用 {#using-configuration-files}&quot;">​</a></h2><p>如果你是使用 ES 模块作为配置文件，即使用 <code>import</code> 和 <code>export</code> 语法，那么你需要确保 Node 能够以 ES 模块形式加载你的配置。</p><p>最简单的方法是将文件扩展名更改为 <code>.mjs</code>，详情请参阅 <a href="./../command-line-interface/#configuration-files">配置文件</a>。</p><p>当你使用 Node ES 模块时，有一些额外的注意事项，最重要的是</p><ul><li>你不能直接地导入你的 <code>package.json</code> 文件</li><li>你不能使用 <code>__dirname</code> 来获取当前目录</li></ul><p>参阅 <a href="./../command-line-interface/#caveats-when-using-native-node-es-modules">使用原生 Node ES 模块时的注意事项</a> 将为你提供一些处理这些问题的替代方法。</p><p>或者你可以传递 <a href="./../command-line-interface/#bundleconfigascjs"><code>--bundleConfigAsCjs</code></a> 选项来强制使用旧的加载行为。</p><p>如果你使用了 <a href="./../command-line-interface/#configplugin-plugin"><code>--configPlugin</code></a> 选项，Rollup 将在运行配置文件之前将其作为 ES 模块进行打包，而不是 CommonJS。这允许你可以轻松地从你的配置文件中导入 ES 模块，但是有一些与使用原生 ES 模块相同的问题，例如 <code>__dirname</code> 将不再起作用。同样，你可以传递 <a href="./../command-line-interface/#bundleconfigascjs"><code>--bundleConfigAsCjs</code></a> 选项来强制使用旧的加载行为。</p><h2 id="changed-defaults" tabindex="-1">默认值更改 <a class="header-anchor" href="#changed-defaults" aria-label="Permalink to &quot;默认值更改 {#changed-defaults}&quot;">​</a></h2><p>目前一些选项设置具有不同的默认值，如果你遇到了任何问题，请尝试将以下内容添加到你的配置文件中：</p><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	makeAbsoluteExternalsRelative: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	preserveEntrySignatures: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;strict&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	output: {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		esModule: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		generatedCode: {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			reservedNamesAsProps: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		},</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		interop: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;compat&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		systemNullSetters: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div><p>总的来说，我们你推荐使用新的默认值，有关每个设置选项的更多详细信息，请参阅相应的文档。</p><h2 id="more-changed-options" tabindex="-1">其他选项更改 <a class="header-anchor" href="#more-changed-options" aria-label="Permalink to &quot;其他选项更改 {#more-changed-options}&quot;">​</a></h2><ul><li><a href="./../configuration-options/#output-banner-output-footer"><code>output.banner/footer</code></a><a href="./../configuration-options/#output-intro-output-outro"><code>/intro/outro</code></a> 现在按块调用，因此不应该执行任何严重影响性能的操作。</li><li><a href="./../configuration-options/#output-entryfilenames"><code>entryFileNames</code></a> 和 <a href="./../configuration-options/#output-chunkfilenames"><code>chunkFileNames</code></a> 函数不再通过 <code>modules</code> 访问呈现的模块信息，而只能访问包含的 <code>moduleIds </code>列表。</li><li>当使用 <a href="./../configuration-options/#output-preservemodules"><code>output.preserveModules</code></a> 和 <code>entryFileNames</code>, 你不能再使用 <code>[ext]</code>, <code>[extName]</code> 和 <code>[assetExtName]</code> 文件名占位符. 此外，模块的路径不再自动添加到文件名前缀，而是包含在 <code>[name]</code> 占位符中。</li></ul><h2 id="dynamic-import-in-commonjs-output" tabindex="-1">从 CommonJS 输出中的动态导入 <a class="header-anchor" href="#dynamic-import-in-commonjs-output" aria-label="Permalink to &quot;从 CommonJS 输出中的动态导入 {#dynamic-import-in-commonjs-output}&quot;">​</a></h2><p>默认情况下，当使用 <code>cjs</code> 作为输出时，Rollup 现在会将任何外部的（即非打包的）动态导入作为输出中的 <code>import(…)</code> 表达式。在 Node 14 及以上的所有版本中都支持从生成的 CommonJS 输出中加载 CommonJS 和 ES 模块。如果你需要支持旧的 Node 版本，你可以传递参数 <a href="./../configuration-options/#output-dynamicimportincjs"><code>output.dynamicImportInCjs: false</code></a>。</p><h2 id="changes-to-the-plugin-api-v3" tabindex="-1">插件 API 更改 <a class="header-anchor" href="#changes-to-the-plugin-api-v3" aria-label="Permalink to &quot;插件 API 更改 {#changes-to-the-plugin-api-v3}&quot;">​</a></h2><p>重新设计了通用的输出生成流程，参阅 <a href="./../plugin-development/#output-generation-hooks">输出生成钩子</a> 图表以获取新的插件钩子顺序。最明显的变化可能是 <a href="./../plugin-development/#banner"><code>banner</code></a>/<a href="./../plugin-development/#footer"><code>footer</code></a>/<a href="./../plugin-development/#intro"><code>intro</code></a>/<a href="./../plugin-development/#outro"><code>outro</code></a> 不再在开头调用一次，而是按块调用。另一方面，当创建哈希时，<a href="./../plugin-development/#augmentchunkhash"><code>augmentChunkHash</code></a> 现在在 <a href="./../plugin-development/#renderchunk"><code>renderChunk</code></a> 之后执行。</p><p>由于文件哈希现在基于 <code>renderChunk</code> 之后文件的实际内容，因此在生成哈希之前我们不再知道确切的文件名。相反，运行逻辑现在依赖于形式为 <code>DNnau6p-</code> 的哈希占位符。这意味着在 <code>renderChunk</code> 钩子可用的所有文件名都可能包含占位符，并且可能不对应于最终的文件名。但如果你计划在块内使用这些文件名，Rollup 将在 <a href="./../plugin-development/#generatebundle"><code>generateBundle</code></a> 运行之前替换所有占位符。</p><p>这不一定是一个破坏性的更新，但在 <a href="./../plugin-development/#renderchunk"><code>renderChunk</code></a> 中添加或删除导入的插件应该确保它们也更新传递给此钩子的相应 <code>chunk</code> 信息。这将使其他插件能够依赖于准确的块信息，而无需自己解析。有关 <code>renderChunk</code> 钩子的更多信息，请参阅 <a href="./../plugin-development/#renderchunk">相关内容的文档</a>。</p></div></div></main><footer class="VPDocFooter" data-v-39a288b8 data-v-e257564d><!--[--><!--]--><div class="edit-info" data-v-e257564d><div class="edit-link" data-v-e257564d><a class="VPLink link vp-external-link-icon no-icon edit-link-button" href="https://github.com/rollup/rollup-docs-cn/edit/master/docs/migration/index.md" target="_blank" rel="noreferrer" data-v-e257564d><!--[--><span class="vpi-square-pen edit-link-icon" data-v-e257564d></span> 在 GitHub 上编辑此页<!--]--></a></div><!----></div><nav class="prev-next" aria-labelledby="doc-footer-aria-label" data-v-e257564d><span class="visually-hidden" id="doc-footer-aria-label" data-v-e257564d>Pager</span><div class="pager" data-v-e257564d><a class="VPLink link pager-link prev" href="/rollup-docs-cn/troubleshooting/" data-v-e257564d><!--[--><span class="desc" data-v-e257564d>Previous page</span><span class="title" data-v-e257564d>故障排除</span><!--]--></a></div><div class="pager" data-v-e257564d><a class="VPLink link pager-link next" href="/rollup-docs-cn/tools/" data-v-e257564d><!--[--><span class="desc" data-v-e257564d>Next page</span><span class="title" data-v-e257564d>其它工具</span><!--]--></a></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><footer class="VPFooter has-sidebar" data-v-5d98c3a5 data-v-e315a0ad><div class="container" data-v-e315a0ad><p class="message" data-v-e315a0ad>基于 MIT 协议发布</p><p class="copyright" data-v-e315a0ad>Copyright © 2015-present Rollup 社区贡献者</p></div></footer><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"command-line-interface_index.md\":\"DRsxNCpS\",\"configuration-options_index.md\":\"D8Qs-09H\",\"es-module-syntax_index.md\":\"AXBvRWXm\",\"faqs_index.md\":\"Be4pQF8s\",\"guide_en.md\":\"DBMYkgfu\",\"guide_en_index.md\":\"Br8BbPyJ\",\"index.md\":\"4z9Ewov-\",\"introduction_index.md\":\"CjtIsDAF\",\"javascript-api_index.md\":\"DF4Xp6YB\",\"migration_index.md\":\"DMCeHX2-\",\"plugin-development_index.md\":\"CWeCM7sS\",\"repl_index.md\":\"BJsS1X-f\",\"tools_index.md\":\"0yPRLHxH\",\"troubleshooting_index.md\":\"C998Pvw2\",\"tutorial_index.md\":\"CeKArVrj\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"Rollup 中文文档\",\"description\":\"编译 JS 代码\",\"base\":\"/rollup-docs-cn/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"algolia\":{\"apiKey\":\"1ad354aec09a57f18f8d9bec8a913e52\",\"appId\":\"EMNHQTRZYG\",\"indexName\":\"rollup_docs_CN\"},\"editLink\":{\"pattern\":\"https://github.com/rollup/rollup-docs-cn/edit/master/docs/:path\",\"text\":\"在 GitHub 上编辑此页\"},\"footer\":{\"copyright\":\"Copyright © 2015-present Rollup 社区贡献者\",\"message\":\"基于 MIT 协议发布\"},\"logo\":\"/rollup-logo.svg\",\"nav\":[{\"link\":\"/introduction/\",\"text\":\"指南\"},{\"link\":\"/repl/\",\"text\":\"repl\"},{\"link\":\"https://is.gd/rollup_chat\",\"text\":\"聊天\"},{\"link\":\"https://opencollective.com/rollup\",\"text\":\"opencollective\"}],\"outline\":\"deep\",\"sidebar\":[{\"items\":[{\"link\":\"/introduction/\",\"text\":\"简介\"},{\"link\":\"/command-line-interface/\",\"text\":\"命令行接口\"},{\"link\":\"/javascript-api/\",\"text\":\"Javascript API\"}],\"text\":\"起步\"},{\"items\":[{\"link\":\"/tutorial/\",\"text\":\"教程\"},{\"link\":\"/es-module-syntax/\",\"text\":\"ES 模块语法\"},{\"link\":\"/faqs/\",\"text\":\"常见问题\"},{\"link\":\"/troubleshooting/\",\"text\":\"故障排除\"},{\"link\":\"/migration/\",\"text\":\"迁移到 Rollup 4\"},{\"link\":\"/tools/\",\"text\":\"其它工具\"}],\"text\":\"更多信息\"},{\"items\":[{\"link\":\"/configuration-options/\",\"text\":\"配置选项\"},{\"link\":\"/plugin-development/\",\"text\":\"插件开发\"}],\"text\":\"API\"}],\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/rollup/rollup\"},{\"icon\":\"mastodon\",\"link\":\"https://m.webtoo.ls/@rollupjs\"}]},\"locales\":{\"root\":{\"label\":\"简体中文\"},\"zh\":{\"label\":\"English\",\"link\":\"https://rollupjs.org\"}},\"scrollOffset\":134,\"cleanUrls\":false}");</script>
    
  </body>
</html>